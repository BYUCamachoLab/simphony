# Copyright Â© Simphony Project Contributors
# Licensed under the terms of the MIT License
# (see simphony/__init__.py for details)

import numpy as np
import pytest

from simphony.libraries import siepic
from simphony.tools import wl2freq

mzi_s_parameters = np.array(
    [
        [
            [-0.04463059 - 3.85348555e-02j, 0.03791468 - 1.65670645e-02j],
            [0.03791614 - 1.65674861e-02j, -0.04462303 - 3.85407576e-02j],
        ],
        [
            [-0.03791501 - 6.10034051e-02j, 0.04133553 - 2.37359859e-02j],
            [0.04133401 - 2.37360347e-02j, -0.03791505 - 6.09916588e-02j],
        ],
        [
            [-0.03565113 - 6.37895649e-02j, -0.08341049 + 6.49107954e-02j],
            [-0.08341067 + 6.49106957e-02j, -0.0356537 - 6.37917582e-02j],
        ],
        [
            [-0.02270682 - 8.51462210e-02j, 0.02949049 - 2.82800891e-02j],
            [0.02949159 - 2.82789021e-02j, -0.02271708 - 8.51442093e-02j],
        ],
        [
            [-0.02097628 - 7.40575215e-02j, 0.06436091 - 7.75505274e-02j],
            [0.06436067 - 7.75520119e-02j, -0.02096778 - 7.40724643e-02j],
        ],
        [
            [-0.01181197 - 6.11944254e-02j, -0.08389937 + 1.29860682e-01j],
            [-0.08389907 + 1.29860193e-01j, -0.01180817 - 6.11847245e-02j],
        ],
        [
            [-0.03925872 - 6.56142995e-02j, 0.00959868 - 2.08414675e-02j],
            [0.0095955 - 2.08389496e-02j, -0.03925486 - 6.56135099e-02j],
        ],
        [
            [-0.01444806 - 5.36701951e-02j, 0.06839281 - 1.66983606e-01j],
            [0.06839509 - 1.66983660e-01j, -0.01445821 - 5.36601374e-02j],
        ],
        [
            [-0.01271241 - 5.33899607e-02j, -0.06259837 + 1.95986599e-01j],
            [-0.06259596 + 1.95987937e-01j, -0.01271647 - 5.34037132e-02j],
        ],
        [
            [-0.02494601 - 2.20945950e-02j, -0.00720848 + 2.55561372e-02j],
            [-0.00721234 + 2.55489823e-02j, -0.02494267 - 2.20941588e-02j],
        ],
        [
            [0.01211876 - 6.91067871e-02j, 0.05818844 - 2.79851000e-01j],
            [0.05818949 - 2.79848827e-01j, 0.01212512 - 6.91186436e-02j],
        ],
        [
            [0.03324559 - 4.24163165e-02j, -0.04038225 + 2.36810768e-01j],
            [-0.04038177 + 2.36813612e-01j, 0.03325981 - 4.23940076e-02j],
        ],
        [
            [0.07503646 - 1.36955856e-02j, -0.01932495 + 1.16005203e-01j],
            [-0.01932216 + 1.15998970e-01j, 0.07501582 - 1.36971411e-02j],
        ],
        [
            [0.03609354 - 5.33142590e-02j, 0.03211148 - 4.01178834e-01j],
            [0.03211074 - 4.01178229e-01j, 0.0360865 - 5.33057465e-02j],
        ],
        [
            [0.09558368 - 3.02272013e-02j, -0.0112313 + 2.46219393e-01j],
            [-0.01123663 + 2.46225183e-01j, 0.09557903 - 3.02752914e-02j],
        ],
        [
            [0.09473917 - 3.93712650e-02j, -0.00286189 + 2.45028693e-01j],
            [-0.00285623 + 2.45030423e-01j, 0.0947806 - 3.93379922e-02j],
        ],
        [
            [0.01998947 - 1.60733895e-02j, -0.00353223 - 4.89373288e-01j],
            [-0.00353202 - 4.89372669e-01j, 0.01997794 - 1.60727199e-02j],
        ],
        [
            [0.06463397 - 8.93727820e-02j, 0.01337211 + 1.80084991e-01j],
            [0.01337209 + 1.80076723e-01j, 0.06460575 - 8.93348824e-02j],
        ],
        [
            [0.03157801 - 8.00734225e-02j, 0.02387594 + 3.57864496e-01j],
            [0.02387243 + 3.57868423e-01j, 0.03157026 - 8.01466763e-02j],
        ],
        [
            [0.02956797 - 4.56126009e-02j, -0.04541933 - 5.14252173e-01j],
            [-0.04542131 - 5.14250978e-01j, 0.02959902 - 4.55857284e-02j],
        ],
        [
            [0.00624431 - 1.39027390e-01j, 0.00942046 + 7.65663409e-02j],
            [0.00942925 + 7.65654359e-02j, 0.00626149 - 1.39028819e-01j],
        ],
        [
            [0.05149494 - 7.16564745e-02j, 0.06234742 + 4.54777323e-01j],
            [0.06234368 + 4.54776670e-01j, 0.05146629 - 7.16236043e-02j],
        ],
        [
            [0.07708967 - 5.99820313e-02j, -0.0861453 - 4.75746466e-01j],
            [-0.08614798 - 4.75748824e-01j, 0.07708453 - 6.00066736e-02j],
        ],
        [
            [0.01404725 - 4.34224742e-02j, -0.00644745 - 4.12403079e-02j],
            [-0.00644588 - 4.12325287e-02j, 0.01405055 - 4.34227150e-02j],
        ],
        [
            [0.11100129 - 3.57490163e-02j, 0.13262267 + 4.94240432e-01j],
            [0.13262267 + 4.94235931e-01j, 0.11100108 - 3.57700853e-02j],
        ],
        [
            [0.08991462 - 2.47841924e-03j, -0.12667894 - 3.81790452e-01j],
            [-0.12667764 - 3.81796807e-01j, 0.08995224 - 2.45588655e-03j],
        ],
        [
            [0.08546799 + 5.32314390e-02j, -0.05360831 - 1.41760900e-01j],
            [-0.05361283 - 1.41756833e-01j, 0.08543929 + 5.32387284e-02j],
        ],
        [
            [0.09868772 - 6.85563056e-03j, 0.19967064 + 4.75298986e-01j],
            [0.1996717 + 4.75298983e-01j, 0.09867837 - 6.83813358e-03j],
        ],
        [
            [0.10702602 + 5.18395059e-02j, -0.12654207 - 2.60064541e-01j],
            [-0.12653649 - 2.60059194e-01j, 0.10700798 + 5.17823878e-02j],
        ],
        [
            [0.11014618 + 5.50112829e-02j, -0.11042125 - 2.10621760e-01j],
            [-0.1104253 - 2.10627215e-01j, 0.11019197 + 5.50340629e-02j],
        ],
        [
            [0.05787243 + 3.23258382e-02j, 0.2520551 + 4.08239693e-01j],
            [0.25205517 + 4.08239571e-01j, 0.05786652 + 3.23278780e-02j],
        ],
        [
            [0.09887536 + 4.11514971e-02j, -0.10224707 - 1.48718128e-01j],
            [-0.10224997 - 1.48716555e-01j, 0.09886464 + 4.11874787e-02j],
        ],
        [
            [0.06755546 + 3.98103435e-02j, -0.17994784 - 2.36872088e-01j],
            [-0.17994591 - 2.36874171e-01j, 0.06752747 + 3.97713798e-02j],
        ],
        [
            [0.0369604 + 5.73943522e-02j, 0.26832401 + 3.13394869e-01j],
            [0.26832524 + 3.13395050e-01j, 0.03698308 + 5.73956444e-02j],
        ],
        [
            [0.04970337 + 2.02350938e-02j, -0.0526436 - 5.23225470e-02j],
            [-0.05264663 - 5.23214694e-02j, 0.04971245 + 2.02237515e-02j],
        ],
        [
            [0.03623432 + 5.49353307e-02j, -0.22524184 - 2.16919236e-01j],
            [-0.22524166 - 2.16919409e-01j, 0.03624169 + 5.49679502e-02j],
        ],
        [
            [0.03401243 + 6.72185478e-02j, 0.24387036 + 2.13098534e-01j],
            [0.2438699 + 2.13098217e-01j, 0.03398906 + 6.72091133e-02j],
        ],
        [
            [0.00716189 + 5.74121804e-02j, 0.00808872 + 8.28646313e-03j],
            [0.00808773 + 8.27984042e-03j, 0.00716363 + 5.74113566e-02j],
        ],
        [
            [0.0260074 + 7.78300575e-02j, -0.23541402 - 1.73762424e-01j],
            [-0.23542479 - 1.73770149e-01j, 0.0260093 + 7.78110671e-02j],
        ],
        [
            [0.01197183 + 8.42286073e-02j, 0.18746779 + 1.26023316e-01j],
            [0.18747699 + 1.26034659e-01j, 0.0119872 + 8.42427598e-02j],
        ],
        [
            [-0.00624197 + 9.56242750e-02j, 0.05597481 + 3.58601729e-02j],
            [0.05597177 + 3.58591269e-02j, -0.00625072 + 9.56272885e-02j],
        ],
        [
            [-0.00629019 + 8.07437929e-02j, -0.207695 - 1.15495857e-01j],
            [-0.20769134 - 1.15493114e-01j, -0.00629115 + 8.07503029e-02j],
        ],
        [
            [-0.01866223 + 8.07671147e-02j, 0.11861619 + 5.77120091e-02j],
            [0.1186174 + 5.77111893e-02j, -0.01867434 + 8.07572294e-02j],
        ],
        [
            [-0.02247825 + 6.91239900e-02j, 0.0773675 + 3.39106726e-02j],
            [0.07735209 + 3.39030769e-02j, -0.02246628 + 6.91193666e-02j],
        ],
        [
            [-0.02842607 + 4.72993472e-02j, -0.1540875 - 5.59675806e-02j],
            [-0.1540874 - 5.59674645e-02j, -0.02842628 + 4.72996248e-02j],
        ],
        [
            [-0.01851712 + 3.77863880e-02j, 0.05764579 + 1.60702496e-02j],
            [0.05764423 + 1.60696991e-02j, -0.01850981 + 3.77961805e-02j],
        ],
        [
            [-0.01205671 + 2.81280421e-02j, 0.07236243 + 1.50855388e-02j],
            [0.07235358 + 1.50841149e-02j, -0.01207137 + 2.81271771e-02j],
        ],
        [
            [-0.00764806 + 3.01557374e-02j, -0.09612991 - 9.91224908e-03j],
            [-0.09613214 - 9.91255099e-03j, -0.007644 + 3.01516657e-02j],
        ],
        [
            [-0.00353516 + 3.21564321e-02j, 0.01874719 - 4.03168882e-04j],
            [0.01874735 - 4.02852811e-04j, -0.0035357 + 3.21514891e-02j],
        ],
        [
            [-0.01055669 + 3.76191893e-02j, 0.0524211 - 6.84844322e-03j],
            [0.05242107 - 6.84869119e-03j, -0.01054941 + 3.76244000e-02j],
        ],
    ]
)

mzi_monte_carlo_s_parameters = np.array(
    [
        [
            [-6.07589269e-02 - 0.0467203j, -1.38574076e-02 + 0.04453427j],
            [-1.38569604e-02 + 0.04453289j, -6.07509431e-02 - 0.04671424j],
        ],
        [
            [-5.05699095e-02 - 0.05313263j, 1.12835972e-02 - 0.09019379j],
            [1.12837592e-02 - 0.09019399j, -5.05735696e-02 - 0.05313164j],
        ],
        [
            [-5.40481102e-02 - 0.06541386j, 5.39459589e-04 + 0.03532914j],
            [5.37899126e-04 + 0.03532982j, -5.40517169e-02 - 0.06540547j],
        ],
        [
            [-3.48294783e-02 - 0.05941238j, 1.28605636e-02 + 0.08508553j],
            [1.28618179e-02 + 0.08508543j, -3.48369357e-02 - 0.05942694j],
        ],
        [
            [-1.57249297e-02 - 0.05898637j, -3.72897443e-02 - 0.13128231j],
            [-3.72892257e-02 - 0.13128203j, -1.57161893e-02 - 0.05898416j],
        ],
        [
            [-1.80944830e-02 - 0.03088278j, 1.40483750e-02 + 0.02991526j],
            [1.40476601e-02 + 0.02991371j, -1.80893316e-02 - 0.03088749j],
        ],
        [
            [-2.48966475e-03 - 0.0428306j, 6.81551913e-02 + 0.12551407j],
            [6.81552831e-02 + 0.12551665j, -2.48760751e-03 - 0.04281408j],
        ],
        [
            [-2.49501371e-04 - 0.05194382j, -1.07979989e-01 - 0.16243899j],
            [-1.07980914e-01 - 0.16243751j, -2.60427348e-04 - 0.05194827j],
        ],
        [
            [3.58021382e-02 - 0.03599589j, 1.20982022e-02 + 0.01459319j],
            [1.21027178e-02 + 0.01459054j, 3.58003126e-02 - 0.0359941j],
        ],
        [
            [1.34221802e-02 - 0.06615207j, 1.53893738e-01 + 0.17194722j],
            [1.53889358e-01 + 0.17194707j, 1.34166721e-02 - 0.06616632j],
        ],
        [
            [2.21208829e-02 - 0.07476621j, -1.91770840e-01 - 0.18454077j],
            [-1.91774110e-01 - 0.18454107j, 2.21381859e-02 - 0.0747656j],
        ],
        [
            [7.26455880e-02 - 0.11301202j, -1.04341995e-02 - 0.01088175j],
            [-1.04303957e-02 - 0.01088017j, 7.26442593e-02 - 0.11301021j],
        ],
        [
            [4.02452952e-02 - 0.06682351j, 2.70445234e-01 + 0.20520648j],
            [2.70443516e-01 + 0.20520402j, 4.02562164e-02 - 0.06679987j],
        ],
        [
            [4.60563959e-02 - 0.07236583j, -2.70839543e-01 - 0.18028615j],
            [-2.70839917e-01 - 0.18029064j, 4.60158477e-02 - 0.07237595j],
        ],
        [
            [1.62830905e-02 - 0.10873216j, -6.03174179e-02 - 0.03693761j],
            [-6.03145093e-02 - 0.0369288j, 1.62970025e-02 - 0.108742j],
        ],
        [
            [4.24066549e-02 - 0.02888373j, 3.82581048e-01 + 0.21968936j],
            [3.82582648e-01 + 0.21968784j, 4.24107639e-02 - 0.02892028j],
        ],
        [
            [-2.76427928e-03 - 0.04131959j, -3.06619192e-01 - 0.16118533j],
            [-3.06613886e-01 - 0.16118479j, -2.72011462e-03 - 0.04126886j],
        ],
        [
            [-5.85162004e-02 - 0.0367057j, -1.25021271e-01 - 0.06662437j],
            [-1.25028866e-01 - 0.06662837j, -5.85547287e-02 - 0.03670815j],
        ],
        [
            [3.01815211e-02 - 0.05139664j, 4.75869462e-01 + 0.20853137j],
            [4.75870059e-01 + 0.20853266j, 3.01616173e-02 - 0.05137663j],
        ],
        [
            [-8.65661973e-03 - 0.02859754j, -3.20260750e-01 - 0.1299913j],
            [-3.20260105e-01 - 0.12998558j, -8.65371686e-03 - 0.02866558j],
        ],
        [
            [7.09514777e-03 - 0.00272924j, -2.11577328e-01 - 0.07673375j],
            [-2.11574631e-01 - 0.07674152j, 7.12500797e-03 - 0.00269595j],
        ],
        [
            [5.50606166e-02 - 0.09061273j, 5.30227763e-01 + 0.15811184j],
            [5.30227484e-01 + 0.15811225j, 5.50675623e-02 - 0.09061279j],
        ],
        [
            [8.89741528e-02 - 0.01138027j, -2.91662689e-01 - 0.06336738j],
            [-2.91668271e-01 - 0.06336495j, 8.89583201e-02 - 0.01135925j],
        ],
        [
            [1.22421991e-01 - 0.00866062j, -2.72520725e-01 - 0.04880243j],
            [-2.72514069e-01 - 0.04880103j, 1.22407107e-01 - 0.00867307j],
        ],
        [
            [6.81993820e-02 - 0.03748277j, 5.45350806e-01 + 0.07741174j],
            [5.45351291e-01 + 0.07741201j, 6.82015610e-02 - 0.0374845j],
        ],
        [
            [1.47323036e-01 - 0.01573933j, -2.25532354e-01 - 0.01884177j],
            [-2.25539568e-01 - 0.01884658j, 1.47314525e-01 - 0.01577197j],
        ],
        [
            [1.23449065e-01 - 0.01357181j, -3.18785265e-01 - 0.01470777j],
            [-3.18783538e-01 - 0.014703j, 1.23494356e-01 - 0.01354622j],
        ],
        [
            [7.99026000e-02 + 0.03416059j, 5.14748717e-01 - 0.01684406j],
            [5.14748317e-01 - 0.01684309j, 7.98838463e-02 + 0.03416665j],
        ],
        [
            [9.64222920e-02 - 0.0135964j, -1.62397588e-01 + 0.01498158j],
            [-1.62389454e-01 + 0.0149777j, 9.64069722e-02 - 0.01356115j],
        ],
        [
            [7.26620494e-02 + 0.02677752j, -3.41924285e-01 + 0.05163894j],
            [-3.41929642e-01 + 0.05164056j, 7.26374157e-02 + 0.02672232j],
        ],
        [
            [7.55047348e-02 + 0.06288612j, 4.49597933e-01 - 0.09957952j],
            [4.49597460e-01 - 0.09958005j, 7.55336911e-02 + 0.06289496j],
        ],
        [
            [2.78175408e-02 + 0.03630503j, -8.91021024e-02 + 0.02894628j],
            [-8.91014732e-02 + 0.02894974j, 2.78340933e-02 + 0.03629231j],
        ],
        [
            [4.94189692e-02 + 0.06301021j, -3.23408516e-01 + 0.11574237j],
            [-3.23409700e-01 + 0.11574025j, 4.94189832e-02 + 0.06305781j],
        ],
        [
            [5.92461919e-02 + 0.06281122j, 3.61991160e-01 - 0.15496582j],
            [3.61991936e-01 - 0.15496749j, 5.92207531e-02 + 0.06279186j],
        ],
        [
            [2.45885210e-02 + 0.08569097j, -3.04126118e-02 + 0.01676868j],
            [-3.04124465e-02 + 0.01677189j, 2.45819812e-02 + 0.08569325j],
        ],
        [
            [5.13207382e-02 + 0.06578898j, -2.84136816e-01 + 0.16181095j],
            [-2.84136930e-01 + 0.16181076j, 5.13309547e-02 + 0.06575893j],
        ],
        [
            [4.76018727e-02 + 0.06619713j, 2.67314175e-01 - 0.17596445j],
            [2.67313731e-01 - 0.17596406j, 4.76176967e-02 + 0.06621768j],
        ],
        [
            [5.32442857e-02 + 0.09267201j, 9.38184585e-03 - 0.00517395j],
            [9.37516966e-03 - 0.00517471j, 5.32425427e-02 + 0.09267186j],
        ],
        [
            [3.32660940e-02 + 0.07057563j, -2.21862775e-01 + 0.18414457j],
            [-2.21873750e-01 + 0.18415365j, 3.32547079e-02 + 0.07059229j],
        ],
        [
            [2.74427275e-02 + 0.07627594j, 1.74354662e-01 - 0.16280845j],
            [1.74366821e-01 - 0.16281416j, 2.74357282e-02 + 0.07625692j],
        ],
        [
            [2.63654569e-02 + 0.07366382j, 2.79163904e-02 - 0.02746451j],
            [2.79146627e-02 - 0.02746171j, 2.63710311e-02 + 0.0736645j],
        ],
        [
            [-6.48561105e-03 + 0.07527187j, -1.50393944e-01 + 0.172274j],
            [-1.50388190e-01 + 0.17226903j, -6.47990210e-03 + 0.07526305j],
        ],
        [
            [-1.66495125e-02 + 0.06287576j, 9.63051753e-02 - 0.12534871j],
            [9.63046928e-02 - 0.12534987j, -1.66418759e-02 + 0.06289003j],
        ],
        [
            [-2.70092155e-02 + 0.04655459j, 2.80920965e-02 - 0.0399397j],
            [2.80810101e-02 - 0.03992486j, -2.70172318e-02 + 0.04655452j],
        ],
        [
            [-3.05495618e-02 + 0.04498937j, -8.00309527e-02 + 0.13835036j],
            [-8.00328074e-02 + 0.13835293j, -3.05534366e-02 + 0.04499525j],
        ],
        [
            [-3.00866625e-02 + 0.03067501j, 3.90246471e-02 - 0.08272028j],
            [3.90239784e-02 - 0.08271908j, -3.00914134e-02 + 0.03066021j],
        ],
        [
            [-2.37066917e-02 + 0.02603948j, 1.53715131e-02 - 0.0407445j],
            [1.53682283e-02 - 0.04073438j, -2.36971514e-02 + 0.02604317j],
        ],
        [
            [-9.13836418e-03 + 0.02988869j, -2.37714432e-02 + 0.09558664j],
            [-2.37711919e-02 + 0.09558555j, -9.13589622e-03 + 0.02988716j],
        ],
        [
            [-9.74932278e-03 + 0.03794185j, 5.18341927e-03 - 0.04592224j],
            [5.18370342e-03 - 0.04592233j, -9.75101006e-03 + 0.03795213j],
        ],
        [
            [-1.27103158e-02 + 0.04217811j, -3.69696036e-04 - 0.0318777j],
            [-3.70046188e-04 - 0.0318777j, -1.27152475e-02 + 0.04217233j],
        ],
    ]
)


@pytest.fixture(scope="module")
def freqs():
    return np.linspace(wl2freq(1600e-9), wl2freq(1500e-9))


@pytest.fixture
def mzi():
    gc_input = siepic.GratingCoupler()
    y_splitter = siepic.YBranch()
    wg_long = siepic.Waveguide(length=150e-6)
    wg_short = siepic.Waveguide(length=50e-6)
    y_recombiner = siepic.YBranch()
    gc_output = siepic.GratingCoupler()

    y_splitter.multiconnect(gc_input, wg_long, wg_short)
    y_recombiner.multiconnect(gc_output, wg_short, wg_long)

    return y_splitter.circuit


class TestCircuit:
    def test_s_parameters(self, freqs, mzi):
        assert (
            np.around(mzi_s_parameters, decimals=5)
            == np.around(mzi.s_parameters(freqs), decimals=5)
        ).all()

    def test_monte_carlo_s_parameters(self, freqs, mzi):
        assert (
            np.around(mzi_monte_carlo_s_parameters, decimals=5)
            != np.around(
                mzi.to_subcircuit(permanent=False).monte_carlo_s_parameters(freqs),
                decimals=5,
            )
        ).all()
