# Copyright Â© Simphony Project Contributors
# Licensed under the terms of the MIT License
# (see simphony/__init__.py for details)

import numpy as np
import pytest

from simphony.libraries import siepic
from simphony.tools import wl2freq

mzi_s_parameters = np.array(
    [
        [
            [-0.04463059 - 3.85348555e-02j, 0.03791468 - 1.65670645e-02j],
            [0.03791614 - 1.65674861e-02j, -0.04462303 - 3.85407576e-02j],
        ],
        [
            [-0.03791501 - 6.10034051e-02j, 0.04133553 - 2.37359859e-02j],
            [0.04133401 - 2.37360347e-02j, -0.03791505 - 6.09916588e-02j],
        ],
        [
            [-0.03565113 - 6.37895649e-02j, -0.08341049 + 6.49107954e-02j],
            [-0.08341067 + 6.49106957e-02j, -0.0356537 - 6.37917582e-02j],
        ],
        [
            [-0.02270682 - 8.51462210e-02j, 0.02949049 - 2.82800891e-02j],
            [0.02949159 - 2.82789021e-02j, -0.02271708 - 8.51442093e-02j],
        ],
        [
            [-0.02097628 - 7.40575215e-02j, 0.06436091 - 7.75505274e-02j],
            [0.06436067 - 7.75520119e-02j, -0.02096778 - 7.40724643e-02j],
        ],
        [
            [-0.01181197 - 6.11944254e-02j, -0.08389937 + 1.29860682e-01j],
            [-0.08389907 + 1.29860193e-01j, -0.01180817 - 6.11847245e-02j],
        ],
        [
            [-0.03925872 - 6.56142995e-02j, 0.00959868 - 2.08414675e-02j],
            [0.0095955 - 2.08389496e-02j, -0.03925486 - 6.56135099e-02j],
        ],
        [
            [-0.01444806 - 5.36701951e-02j, 0.06839281 - 1.66983606e-01j],
            [0.06839509 - 1.66983660e-01j, -0.01445821 - 5.36601374e-02j],
        ],
        [
            [-0.01271241 - 5.33899607e-02j, -0.06259837 + 1.95986599e-01j],
            [-0.06259596 + 1.95987937e-01j, -0.01271647 - 5.34037132e-02j],
        ],
        [
            [-0.02494601 - 2.20945950e-02j, -0.00720848 + 2.55561372e-02j],
            [-0.00721234 + 2.55489823e-02j, -0.02494267 - 2.20941588e-02j],
        ],
        [
            [0.01211876 - 6.91067871e-02j, 0.05818844 - 2.79851000e-01j],
            [0.05818949 - 2.79848827e-01j, 0.01212512 - 6.91186436e-02j],
        ],
        [
            [0.03324559 - 4.24163165e-02j, -0.04038225 + 2.36810768e-01j],
            [-0.04038177 + 2.36813612e-01j, 0.03325981 - 4.23940076e-02j],
        ],
        [
            [0.07503646 - 1.36955856e-02j, -0.01932495 + 1.16005203e-01j],
            [-0.01932216 + 1.15998970e-01j, 0.07501582 - 1.36971411e-02j],
        ],
        [
            [0.03609354 - 5.33142590e-02j, 0.03211148 - 4.01178834e-01j],
            [0.03211074 - 4.01178229e-01j, 0.0360865 - 5.33057465e-02j],
        ],
        [
            [0.09558368 - 3.02272013e-02j, -0.0112313 + 2.46219393e-01j],
            [-0.01123663 + 2.46225183e-01j, 0.09557903 - 3.02752914e-02j],
        ],
        [
            [0.09473917 - 3.93712650e-02j, -0.00286189 + 2.45028693e-01j],
            [-0.00285623 + 2.45030423e-01j, 0.0947806 - 3.93379922e-02j],
        ],
        [
            [0.01998947 - 1.60733895e-02j, -0.00353223 - 4.89373288e-01j],
            [-0.00353202 - 4.89372669e-01j, 0.01997794 - 1.60727199e-02j],
        ],
        [
            [0.06463397 - 8.93727820e-02j, 0.01337211 + 1.80084991e-01j],
            [0.01337209 + 1.80076723e-01j, 0.06460575 - 8.93348824e-02j],
        ],
        [
            [0.03157801 - 8.00734225e-02j, 0.02387594 + 3.57864496e-01j],
            [0.02387243 + 3.57868423e-01j, 0.03157026 - 8.01466763e-02j],
        ],
        [
            [0.02956797 - 4.56126009e-02j, -0.04541933 - 5.14252173e-01j],
            [-0.04542131 - 5.14250978e-01j, 0.02959902 - 4.55857284e-02j],
        ],
        [
            [0.00624431 - 1.39027390e-01j, 0.00942046 + 7.65663409e-02j],
            [0.00942925 + 7.65654359e-02j, 0.00626149 - 1.39028819e-01j],
        ],
        [
            [0.05149494 - 7.16564745e-02j, 0.06234742 + 4.54777323e-01j],
            [0.06234368 + 4.54776670e-01j, 0.05146629 - 7.16236043e-02j],
        ],
        [
            [0.07708967 - 5.99820313e-02j, -0.0861453 - 4.75746466e-01j],
            [-0.08614798 - 4.75748824e-01j, 0.07708453 - 6.00066736e-02j],
        ],
        [
            [0.01404725 - 4.34224742e-02j, -0.00644745 - 4.12403079e-02j],
            [-0.00644588 - 4.12325287e-02j, 0.01405055 - 4.34227150e-02j],
        ],
        [
            [0.11100129 - 3.57490163e-02j, 0.13262267 + 4.94240432e-01j],
            [0.13262267 + 4.94235931e-01j, 0.11100108 - 3.57700853e-02j],
        ],
        [
            [0.08991462 - 2.47841924e-03j, -0.12667894 - 3.81790452e-01j],
            [-0.12667764 - 3.81796807e-01j, 0.08995224 - 2.45588655e-03j],
        ],
        [
            [0.08546799 + 5.32314390e-02j, -0.05360831 - 1.41760900e-01j],
            [-0.05361283 - 1.41756833e-01j, 0.08543929 + 5.32387284e-02j],
        ],
        [
            [0.09868772 - 6.85563056e-03j, 0.19967064 + 4.75298986e-01j],
            [0.1996717 + 4.75298983e-01j, 0.09867837 - 6.83813358e-03j],
        ],
        [
            [0.10702602 + 5.18395059e-02j, -0.12654207 - 2.60064541e-01j],
            [-0.12653649 - 2.60059194e-01j, 0.10700798 + 5.17823878e-02j],
        ],
        [
            [0.11014618 + 5.50112829e-02j, -0.11042125 - 2.10621760e-01j],
            [-0.1104253 - 2.10627215e-01j, 0.11019197 + 5.50340629e-02j],
        ],
        [
            [0.05787243 + 3.23258382e-02j, 0.2520551 + 4.08239693e-01j],
            [0.25205517 + 4.08239571e-01j, 0.05786652 + 3.23278780e-02j],
        ],
        [
            [0.09887536 + 4.11514971e-02j, -0.10224707 - 1.48718128e-01j],
            [-0.10224997 - 1.48716555e-01j, 0.09886464 + 4.11874787e-02j],
        ],
        [
            [0.06755546 + 3.98103435e-02j, -0.17994784 - 2.36872088e-01j],
            [-0.17994591 - 2.36874171e-01j, 0.06752747 + 3.97713798e-02j],
        ],
        [
            [0.0369604 + 5.73943522e-02j, 0.26832401 + 3.13394869e-01j],
            [0.26832524 + 3.13395050e-01j, 0.03698308 + 5.73956444e-02j],
        ],
        [
            [0.04970337 + 2.02350938e-02j, -0.0526436 - 5.23225470e-02j],
            [-0.05264663 - 5.23214694e-02j, 0.04971245 + 2.02237515e-02j],
        ],
        [
            [0.03623432 + 5.49353307e-02j, -0.22524184 - 2.16919236e-01j],
            [-0.22524166 - 2.16919409e-01j, 0.03624169 + 5.49679502e-02j],
        ],
        [
            [0.03401243 + 6.72185478e-02j, 0.24387036 + 2.13098534e-01j],
            [0.2438699 + 2.13098217e-01j, 0.03398906 + 6.72091133e-02j],
        ],
        [
            [0.00716189 + 5.74121804e-02j, 0.00808872 + 8.28646313e-03j],
            [0.00808773 + 8.27984042e-03j, 0.00716363 + 5.74113566e-02j],
        ],
        [
            [0.0260074 + 7.78300575e-02j, -0.23541402 - 1.73762424e-01j],
            [-0.23542479 - 1.73770149e-01j, 0.0260093 + 7.78110671e-02j],
        ],
        [
            [0.01197183 + 8.42286073e-02j, 0.18746779 + 1.26023316e-01j],
            [0.18747699 + 1.26034659e-01j, 0.0119872 + 8.42427598e-02j],
        ],
        [
            [-0.00624197 + 9.56242750e-02j, 0.05597481 + 3.58601729e-02j],
            [0.05597177 + 3.58591269e-02j, -0.00625072 + 9.56272885e-02j],
        ],
        [
            [-0.00629019 + 8.07437929e-02j, -0.207695 - 1.15495857e-01j],
            [-0.20769134 - 1.15493114e-01j, -0.00629115 + 8.07503029e-02j],
        ],
        [
            [-0.01866223 + 8.07671147e-02j, 0.11861619 + 5.77120091e-02j],
            [0.1186174 + 5.77111893e-02j, -0.01867434 + 8.07572294e-02j],
        ],
        [
            [-0.02247825 + 6.91239900e-02j, 0.0773675 + 3.39106726e-02j],
            [0.07735209 + 3.39030769e-02j, -0.02246628 + 6.91193666e-02j],
        ],
        [
            [-0.02842607 + 4.72993472e-02j, -0.1540875 - 5.59675806e-02j],
            [-0.1540874 - 5.59674645e-02j, -0.02842628 + 4.72996248e-02j],
        ],
        [
            [-0.01851712 + 3.77863880e-02j, 0.05764579 + 1.60702496e-02j],
            [0.05764423 + 1.60696991e-02j, -0.01850981 + 3.77961805e-02j],
        ],
        [
            [-0.01205671 + 2.81280421e-02j, 0.07236243 + 1.50855388e-02j],
            [0.07235358 + 1.50841149e-02j, -0.01207137 + 2.81271771e-02j],
        ],
        [
            [-0.00764806 + 3.01557374e-02j, -0.09612991 - 9.91224908e-03j],
            [-0.09613214 - 9.91255099e-03j, -0.007644 + 3.01516657e-02j],
        ],
        [
            [-0.00353516 + 3.21564321e-02j, 0.01874719 - 4.03168882e-04j],
            [0.01874735 - 4.02852811e-04j, -0.0035357 + 3.21514891e-02j],
        ],
        [
            [-0.01055669 + 3.76191893e-02j, 0.0524211 - 6.84844322e-03j],
            [0.05242107 - 6.84869119e-03j, -0.01054941 + 3.76244000e-02j],
        ],
    ]
)


@pytest.fixture(scope="module")
def freqs():
    return np.linspace(wl2freq(1600e-9), wl2freq(1500e-9))


@pytest.fixture
def mzi():
    gc_input = siepic.GratingCoupler()
    y_splitter = siepic.YBranch()
    wg_long = siepic.Waveguide(length=150e-6)
    wg_short = siepic.Waveguide(length=50e-6)
    y_recombiner = siepic.YBranch()
    gc_output = siepic.GratingCoupler()

    y_splitter.multiconnect(gc_input, wg_long, wg_short)
    y_recombiner.multiconnect(gc_output, wg_short, wg_long)

    return y_splitter.circuit


class TestCircuit:
    def test_s_parameters(self, freqs, mzi):
        assert mzi_s_parameters == mzi.s_parameters(freqs)
